---
title: "Get started with rmangal"
author:
  - name: Steve Vissault & Kevin Cazelles
bibliography:
  - ../inst/bib/main.bib
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup, include = FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  collapse = TRUE,
  comment = "#>"
)
# library(sf)
```


# Context

## The Mangal project

[The Mangal project](https://mangal.io) aims at archiving published ecological networks and at easing their retrieval. To do so, Mangal:

1. uses a data specification for ecological networks [described in @poisot_mangal_2016];

2. archives ecological networks in a [PostgreSQL](https://www.postgresql.org/) database;

3. provides:
  - [a data explorer](https://mangal.io/#/) to visualize and download data available;
  - a [RESTFUL Application Programming Interface (API)](https://mangal-wg.github.io/mangal-api/);
  - a client library for Julia: [Mangal.jl](https://github.com/PoisotLab/Mangal.jl);
  - a client of this API for R: the **rmangal** package described below.

Currently, 172 datasets are including in the database representing over [1300
ecological networks](https://mangal.io/#/network). In 2016, a first
paper describing the project was published and introduced the first release of
**rmangal** [@poisot_mangal_2016]. Since then, the structure of the database has
been improved (new fields have been added), several ecological networks added
and the API entirely re-written. Consequently, [the first release of the
**rmangal**](https://github.com/mangal-wg/rmangal-v1) is obsolete (and archived) and we introduce **rmangal v2.0**. in this vignette.



## Data structure

<br>

<div class = "row">
<div class = "col-md-6">
```{R echo = FALSE}
knitr::include_graphics("figs/data_structure.svg")
```
</div>
<div class = "col-md-6">

The diagram on the left side represents the structure of the Mangal database. All *references*
included in Mangal correspond to a specific publication that includes one or several *dataset(s)*. This dataset is
basically a collection of ecological *networks* whose *nodes* and *interactions* (edges) are stored
in separate tables. Below, we briefly describe the content of each table.

**References** -- Information pertaining to a reference (scientific article, book, online website,
etc.) characterizing an original collection of ecological networks. URLs of data and publication
sources are included as well as persistent identifiers (when available) such as digital object
identifiers (DOIs). This allows the user to retrieve more details about original publications using
appropriate R packages such as [crossref](https://docs.ropensci.org/rcrossref/).

**Datasets** -- Metadata of the datasets attached to a reference. It includes a general description
of the networks.

**Networks** -- Metadata of the networks attached to a dataset. It provides the sampling location, date and
specific description of the network.

**Nodes** -- Information on the population, taxa or individu in the network.
Each node has an original name / taxonomy and a taxonomic identifier extract from


**Interactions** -- Information on the interaction type (e.g mutualism,
predation, etc.), the strength, and the direction of the interaction between
two nodes.

</div>
</div>


## Authentification

So far, the `rmangal` package provides methods to get access to the datastore. Data requests
(performed via `httr::GET()`) do not require any authentification.

A bearer authentification strategy using [ORCID](https://orcid.org/) credentials
(as a third party services) has been implemented on all `POST`, `DELETE`, `PUT`
API operations to allow the user to add and delete new ecological to the data
base. These features are not currently included in the **rmangal** package, but
are under consideration for future major releases.



# How to use **rmangal**

## Overall approach

In order to efficiently retrieve networks from the data base, **rmangal**
includes 6 search functions that queries the 5 tables described above as well as a table dedicated to taxonomy.

1. `search_reference()`: search in the reference table, for instance the user can look for a specific `doi`;
2. `search_datasets()`: search among datasets using a keyword;
3. `search_networks()`: search networks based on a keyword or a geographical area;
4. `search_interactions()`: list all networks containing a specific interaction type;
5. `search_nodes()`: identify nodes based on nodes informations;
6. `search_taxonomy()`: identify nodes based on taxonomic names and identifiers.


All of these functions return specific objects containing the information needed
to retrieve the corresponding set of ecological networks with
`get_collection()`. Hence, the user can easily retrieve data in two steps:

```r
networks <- search_*() %>% get_collection()
```

Note that if there is only one network to be retrieved, `get_collection()`
returns a `mgNetwork` object, otherwise it returns a object of class
`mgNetworksCollection` which is a collection (a list) of `mgNetwork` objects.
Below, we exemplify how to used the search functions, how to get a collection f networks and how to use other package to carry out specific analyses.




## Search functions

In **rmangal**, every functions queries a specific table and allow only one
query at a time (see section [Batch analysis](#batch-analysis) below to learn
how to deal with more than one query). All the function offer two ways to query
the corresponding table:

1.a keyword: in this case, entries returned are partial matches with values of any of the field of the table including character strings;
2.a custom query: in this case, entries returned are exact matches.

Let's firs **rmangal** as well as two helper packages:

```{R load_packages}
library(rmangal)
library(magrittr) # for the pip %>%
library(tibble) # to use tibbles, enhanced data frames
```

### Search and list available datasets

Let's assume we are looking for ecological networks including species living in lagoons. If we have no idea about any existing data set, the best starting point is then to query the `dataset` table with `lagoon` as a keyword:

```{R}
lagoon <- search_datasets(query = "lagoon")
class(lagoon)
lagoon
```

If the Mangal dataset identifier was known, we could a custo query:

```{R}
lagoon_zetina <- search_datasets(list(ref_id = 53))
lagoon_zetina
```

Note that if an empty character is passed, i.e. `""`, all the entries of the database queried are returned. Here we can use this behaviour to list all  datasets available:

```{R}
all_datasets <- search_datasets("")
glimpse(all_datasets)
```

As showed in the diagram above, a dataset comes from a specific reference and `search_refernece()` allows to query directly the reference table. A handy argument of this function is `doi` as it allows to pass a Digital Object Identifier and so to retrieve the dataset attached to a specific publication.


```{R}
zetina_2003 <- search_reference(doi = "10.1016/s0272-7714(02)00410-9")
```



### Finding a specific network

Datasets includes one or several ecological networks and **rmangal** lets the user query network individually

```{R}
insect_coll <- search_networks(query="insect%")
glimpse(insect_coll)
```

Also, `search_networks()` allow sptial queries, i.e. the user can provide a
[`sf`](https://cran.r-project.org/web/packages/sf/sf.pdf) object to access all
networks included in the spatial extent of this object. Here, we request all
networks in California:

```{R}
library(mapview)
library(USAboundaries)
area <- us_states(state = "california")
in_CA <- search_networks(area)
mapview(in_CA, legend = FALSE)
```

It is also possible to retrieve all networks including interactions of a
specific type:

```{R}
# List all interaction type available
avail_type()
comp_interac <- search_interactions(type="competition")
# Number of competition interactions in mangal
nrow(comp_interac)
```



### Search for a specific taxon

The user can easily identify networks including a specific taxonomic entity
with `search_taxonomy()`:

```{R}
sr_ficus <- search_taxonomy("Ficus")
```

This function allows to search a specific taxonomic entity using its validated
name and unique identifiers, i.e. EOL, TSN, GBIF, COL, BOLD and NCBI IDs. Note
that the taxonomy backbone contains names and identifiers validated with
taxize [@chamberlain_2019].

```{R}
glimpse(search_taxonomy(tsn = 28749))
glimpse(search_taxonomy(eol = 583069))
```

Note that in some case, one may need to find a dataset based on the original name included in the publication, in such case, `search_nodes()` must be used:

```{R}
sr_ficus2 <- search_nodes("Ficus")
```


## Get networks associated to a `search_*` object

Once the search performed, ecological networks are downloaded using the object
obtained and `get_collection()`:

```{R}
nets_lagoons <- lagoon %>% get_collection
nets_in_CA <- in_CA %>% get_collection
nets_competition <- comp_interac %>% get_collection
```

```{R}
nets_lagoons
class(nets_lagoons)
```

Note that `mgNetworksCollection` objects are lists of `mgNetwork` object which are a list of five datasets reflecting the 5 tables presented in the diagram in the first section:

```{R}
names(nets_lagoons[[1]])
glimpse(nets_lagoons[[1]]$network)
glimpse(nets_lagoons[[1]]$nodes)
glimpse(nets_lagoons[[1]]$edges)
glimpse(nets_lagoons[[1]]$dataset)
glimpse(nets_lagoons[[1]]$reference)
```



# Integrated workflow with **rmangal**

## Creating a list references for a set of networks

This manipulation BibTeX of all publications involved in the networks collection.
<!-- [RefManageR](https://cran.r-project.org/web/packages/RefManageR/index.html) -->

```{R, message = FALSE}
# library(RefManageR)
# tmpf <- tempfile(, fileext = ".bib")
search_datasets(query = 'lagoon') %>%
  get_collection %>% get_citation %>% cat(sep = "\n")
# file = tmpf)
# ReadBib(tmpf)
```


## Network analysis with `igraph`

Once the data are retrieved and a `mgNetwork` or a `mgNetworkCollection` objects
obtained, it is straightforward to convert it as a `igraph` (see the [dedicated
website](https://igraph.org/r/):) object and then to carry out network analysis:

```{R}
library(igraph)
ig_lagoons <- search_datasets(query = 'lagoon') %>% get_collection %>% mg_to_igraph
## Modularity analysis for the firt network
modularity(ig_lagoons[[1]], membership(cluster_walktrap(ig_lagoons[[1]])))
## Degree values for all networks
lapply(ig_lagoons, degree)
```

## Taxonomic analysis with `taxize`

As Mangal includes taxonomic identifiers, **rmangal** can readily be combined
with `taxize` (see [taxize book](https://ropenscilabs.github.io/taxize-book/) fr more details about tha package):

```{R}
library(taxize)
tsn_acer <- search_taxonomy("Acer")$taxonomy.tsn
classification(tsn_acer, db = "itis")
```

## Batch analysis

So far, the search functions of **rmangal** allow the user to perform only a
single search at a time. The simplest way to do more than one search is to loop
over a vector or a list of queries. Below we exemplify how to do so using
`lapply()`:

```{R}
tsn <- c(837855, 169237)
mgn <- lapply(tsn, function(x) search_taxonomy(tsn = x)) %>%
  lapply(get_collection) %>%
  combine_mgNetworks
mgn
```


## References
